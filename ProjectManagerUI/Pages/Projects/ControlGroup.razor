@page "/projects/control-group/{ControlGroupId:int}"
@inject IEmptyClass EmptyClass

<PageTitle>Projects - @EmptyClass.Location</PageTitle>
<ProjectNavigation emptyClass="@EmptyClass"></ProjectNavigation>

<!-- Info cards -->
<div class="row">
    <div class="col-lg-4 mb-3">
        <div class="card p-0 h-100" style="background-image: linear-gradient(180deg, rgba(25,55,80,1) 0%, rgba(50,110,129,1) 80%); color: rgb(250,250,250); ">
            <div class="card-header">
                Info card
            </div>
            <div class="card-body">
                <h6>Info header</h6>
                <p class="card-text">Informaton text here</p>
                <p class="card-text">Informaton text here</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-3">
        <div class="card p-0 h-100" style="background-image: linear-gradient(180deg, rgba(25,55,80,1) 0%, rgba(50,110,129,1) 80%); color: rgb(250,250,250); ">
            <div class="card-header">
                Info card
            </div>
            <div class="card-body">
                <h6>Info header</h6>
                <p class="card-text">Informaton text here</p>
                <p class="card-text">Informaton text here</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-3">
        <div class="card p-0 h-100" style="background-image: linear-gradient(180deg, rgba(25,55,80,1) 0%, rgba(50,110,129,1) 80%); color: rgb(250,250,250); ">
            <div class="card-header">
                Info card
            </div>
            <div class="card-body">
                <h6>Info header</h6>
                <p class="card-text">Informaton text here</p>
                <p class="card-text">Informaton text here</p>
            </div>
        </div>
    </div>
</div>
<!-- Child relation cards -->
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 row-cols-xxl-5 g-4">
    @foreach (RelationModel childRelation in ChildRelations)
    {
        <FunctionGroupCard OnClickCallback="ClickCard" CardId="@childRelation.Id" CardName="@childRelation.Relation_name" CardText="Some function group descriptive text here" FooterText="..."></FunctionGroupCard>
    }
</div>
<!--  Edit menu -->
<div class="dropup" style=" position: absolute; right: 20px; bottom: 20px;">
    <button type="button" class="btn btn-primary dropdown p-1" data-bs-toggle="dropdown">
        <span class="oi oi-plus p-1" aria-hidden="true"></span>
    </button>
    <ul class="dropdown-menu">
        <li><button type="button" data-bs-toggle="modal" data-bs-target="#addChildModal" class="dropdown-item">Add</button></li>
        <li><button type="button" data-bs-toggle="modal" data-bs-target="#editRelationModal" class="dropdown-item">Edit</button></li>
    </ul>
</div>

<!-- Modal - Add child relation -->
<AddChildModal NewChild="@NewFunctionGroup" OnSubmitCallback="@SubmitAddFunctionGroup"></AddChildModal>
<!-- Modal - Edit relation -->
<EditRelationModal UpdatedRelation="@UpdatedControlGroup" PossibleParents="@PossibleParents" OnSubmitCallback="@SubmitUpdateControlGroup"></EditRelationModal>

<!-- Modal - Delete child relation -->
<div class="modal fade" id="staticBackdrop1" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel1">Delete function group</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="row">
                    <div class="col">
                        Are you sure? This will delete function group and all its child relations!
                    </div>
                </div>
                <div class="row justify-content-evenly">
                    <div class="col-4">
                        <button @onclick="DeleteFunctionGroup" type="button" class="btn btn-danger" data-bs-dismiss="modal">Delete</button>
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal - Edit relation -->
<div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel2" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel2">Edit Control Group</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <EditForm Model="@UpdatedControlGroup" OnSubmit="@SubmitUpdateControlGroup" class="row g-3">
                    <div class="col-12 mb-1">
                        <label for="formGroupExampleInput2" class="form-label">Name</label>
                        <InputText class="form-control" id="formGroupExampleInput2" @bind-Value="UpdatedControlGroup!.Relation_name" />
                    </div>
                    <div class="col-12 mb-1">
                        <label for="formGroupExampleInput3" class="form-label">Parent relation</label>
                        <InputSelect class="form-select" id="formGroupExampleInput3" @bind-Value="UpdatedControlGroup!.Parent_id">
                            <option selected>Select parent ...</option>
                            @foreach (var item in PossibleParents)
                            {
                                <option value="@item.Id">@item.Relation_name</option>
                            }
                        </InputSelect>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Update</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>
@code {
    #region PageBase
    [Parameter]
    public int? ControlGroupId { get; set; }
    public int? ClickedCardId { get; set; }
    public RelationModel controlGroup = new();
    public List<RelationModel> ChildRelations = new();
    protected override async Task OnInitializedAsync()
    {
        GetRelationWithId();
        await GetChildRelations();
        EmptyClass.SetControlGroup(controlGroup.Relation_name, ControlGroupId);
        UpdatedControlGroup = controlGroup;
        await GetPossibleParents();
    }
    //Get relation
    private void GetRelationWithId()
    {
        controlGroup = RelationDataAccess.GetRelation(ControlGroupId);
    }
    //Get all child relations
    private async Task GetChildRelations()
    {
        ChildRelations = await RelationDataAccess.GetChildRelations(ControlGroupId);
    }
    protected void ClickCard(int? id)
    {
        ClickedCardId = id;
    }
    #endregion
    #region FeatureCreateNewFunctionGroup
    public RelationModel NewFunctionGroup = new();
    private async Task SubmitAddFunctionGroup()
    {
        NewFunctionGroup.Parent_id = ControlGroupId;
        NewFunctionGroup.Role_id = 6;
        var result = await RelationDataAccess.PostRelationAsync(NewFunctionGroup);
        await GetChildRelations();
    }
    #endregion
    #region FeatureDeleteFunctionGroup
    private async Task DeleteFunctionGroup()
    {
        await RelationDataAccess.DeleteRelationAsync(ClickedCardId);
        await GetChildRelations();
    }
    #endregion
    #region FeatureUpdateConrolGroup
    private RelationModel UpdatedControlGroup = new();
    private List<RelationModel> PossibleParents = new();
    private async Task GetPossibleParents()
    {
        if (controlGroup.Parent_id >= 0)
        {
            RelationModel parent = RelationDataAccess.GetRelation(controlGroup.Parent_id);
            PossibleParents = await RelationDataAccess.GetChildRelations(parent.Parent_id);
        }
    }
    private async Task SubmitUpdateControlGroup()
    {
        var result = await RelationDataAccess.UpdateRelationAsync(UpdatedControlGroup);
    }
    #endregion
}